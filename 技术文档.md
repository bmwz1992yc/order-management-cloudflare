好的，为您提供一个基于 **Cloudflare Workers** 和 **R2** 的完整订单管理系统示例代码。

这个方案包括了前端 HTML 界面、Workers 后端逻辑（用于处理配置、订单增删改查、图片上传、大模型识别和 CSV 导出）以及必要的配置文件。

-----

## 项目结构

您的项目文件结构将如下所示：

```
order-manager-worker/
├── node_modules/
├── package.json
├── wrangler.toml           # Cloudflare Workers/R2/Secrets 配置
└── src/
    ├── index.js          # Workers 主代码（后端 API 逻辑）
    └── static/
        └── index.html    # 前端界面
```

-----

## 1\. Cloudflare Workers 配置 (`wrangler.toml`)

请确保您已安装 `wrangler` CLI 工具。这个文件定义了您的 Workers、R2 绑定和静态资产。

```toml
name = "order-manager-worker"
main = "src/index.js"
compatibility_date = "2024-05-18" # 使用最新日期

# 启用 Workers Pages 资产功能
[site]
bucket = "./src/static" # 静态文件目录

# R2 绑定：将 R2 Bucket 命名为 'ORDER_DATA' 并在 Workers 代码中引用
[[r2_buckets]]
binding = "ORDER_DATA"
bucket_name = "your-order-data-bucket-name" # <-- 替换为您创建的 R2 桶名称
```

### 部署前准备：

1.  **创建 R2 存储桶：** 使用 `npx wrangler r2 bucket create your-order-data-bucket-name`。
2.  **设置 API Key 密匙：** 在 Workers 环境中设置您的 AI 服务商 API Key，以确保安全。
      * 运行命令：`npx wrangler secret put AI_API_KEY`，然后输入您的 Key。

## 2\. Workers 后端代码 (`src/index.js`)

这是处理所有 API 请求的核心逻辑。

````javascript
/**
 * Worker 主代码：订单管理系统后端
 * 绑定了 R2 存储桶 ORDER_DATA 和 AI_API_KEY Secret
 */

// --- 常量定义 ---
const DATA_KEY = "orders/orders_data.json"; // 存储订单数据的主文件
const CONFIG_KEY = "system/config.json"; // 存储 API 配置的文件
const IMAGE_PREFIX = "images/"; // R2 中图片存储前缀

// --- 辅助函数：R2 读写 ---

/** 读取 R2 对象并解析为 JSON，如果不存在则返回默认值 */
async function getR2Json(env, key, defaultValue = null) {
    const object = await env.ORDER_DATA.get(key);
    if (object === null) {
        return defaultValue;
    }
    return JSON.parse(await object.text());
}

/** 写入 JSON 对象到 R2 */
async function putR2Json(env, key, data) {
    const json = JSON.stringify(data, null, 2);
    await env.ORDER_DATA.put(key, json, {
        httpMetadata: { contentType: "application/json" }
    });
}

// --- API 路由处理函数 ---

/** GET /api/config: 获取配置 */
async function handleGetConfig(env) {
    const defaultConfig = {
        api_url: "https://api.openai.com/v1/chat/completions",
        model_name: "gpt-4o-mini",
    };
    const config = await getR2Json(env, CONFIG_KEY, defaultConfig);
    return new Response(JSON.stringify(config), {
        headers: { "Content-Type": "application/json" }
    });
}

/** POST /api/config: 更新配置 */
async function handleUpdateConfig(request, env) {
    try {
        const newConfig = await request.json();
        // 确保只保存允许的字段
        const configToSave = {
            api_url: newConfig.api_url,
            model_name: newConfig.model_name
        };
        await putR2Json(env, CONFIG_KEY, configToSave);
        return new Response(JSON.stringify({ message: "配置更新成功" }), {
            status: 200,
            headers: { "Content-Type": "application/json" }
        });
    } catch (e) {
        return new Response(JSON.stringify({ error: "更新配置失败", details: e.message }), {
            status: 400
        });
    }
}

/** GET /api/orders: 获取所有订单数据 */
async function handleGetOrders(env) {
    const orders = await getR2Json(env, DATA_KEY, []);
    // 返回按日期降序排列的订单
    orders.sort((a, b) => new Date(b.upload_date) - new Date(a.upload_date));
    return new Response(JSON.stringify(orders), {
        headers: { "Content-Type": "application/json" }
    });
}

/** POST /api/upload: 上传图片并识别订单信息 */
async function handleUpload(request, env) {
    const formData = await request.formData();
    const imageFile = formData.get("orderImage");

    if (!imageFile || imageFile.size === 0) {
        return new Response("未接收到图片文件", { status: 400 });
    }

    const arrayBuffer = await imageFile.arrayBuffer();
    const base64Image = Buffer.from(arrayBuffer).toString("base64");
    const imageContentType = imageFile.type || 'image/jpeg'; // 默认值

    // 1. 获取 API 配置
    const config = await getR2Json(env, CONFIG_KEY, {});
    const { api_url, model_name } = config;

    if (!api_url || !model_name || !env.AI_API_KEY) {
        return new Response("AI API 配置缺失或密钥未设置", { status: 500 });
    }

    // 2. 调用大模型 API 进行识别
    const prompt = "请从手写订单图片中识别出客户名称(customer_name)、货物内容(item_content)、订单金额(amount, 只返回数字)、和订单日期(order_date, 格式YYYY-MM-DD)，并严格以 JSON 格式返回结果。";

    try {
        const aiResponse = await fetch(api_url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${env.AI_API_KEY}`
            },
            body: JSON.stringify({
                model: model_name,
                messages: [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: prompt },
                            {
                                type: "image_url",
                                image_url: { url: `data:${imageContentType};base64,${base64Image}` }
                            }
                        ]
                    }
                ],
                // 关键：要求模型返回 JSON 格式
                response_format: { type: "json_object" }
            })
        });

        if (!aiResponse.ok) {
            const errorText = await aiResponse.text();
            throw new Error(`AI API 错误: ${aiResponse.status} - ${errorText}`);
        }

        const aiData = await aiResponse.json();
        // 提取模型返回的 JSON 字符串（通常在 messages[0].content 或 choices[0].message.content 中）
        let extractedJson = aiData.choices[0].message.content;
        
        // 如果返回内容被 Markdown 封装 (```json ... ```)，进行清理
        if (extractedJson.startsWith('```json')) {
             extractedJson = extractedJson.substring(7, extractedJson.lastIndexOf('```')).trim();
        }
        
        const orderData = JSON.parse(extractedJson);

        // 3. 存储图片到 R2
        const orderId = `OD-${Date.now()}`;
        const imageR2Key = `${IMAGE_PREFIX}${orderId}-${imageFile.name}`;
        await env.ORDER_DATA.put(imageR2Key, arrayBuffer, {
            httpMetadata: { contentType: imageContentType }
        });

        // 4. 写入订单记录到 R2 数据文件
        const newRecord = {
            order_id: orderId,
            customer_name: orderData.customer_name || 'N/A',
            item_content: orderData.item_content || 'N/A',
            amount: parseFloat(orderData.amount) || 0,
            order_date: orderData.order_date || new Date().toISOString().substring(0, 10),
            upload_date: new Date().toISOString(),
            image_r2_key: imageR2Key
        };

        const existingOrders = await getR2Json(env, DATA_KEY, []);
        existingOrders.push(newRecord);
        await putR2Json(env, DATA_KEY, existingOrders);

        return new Response(JSON.stringify({ message: "订单识别与存储成功", data: newRecord }), {
            status: 200,
            headers: { "Content-Type": "application/json" }
        });

    } catch (e) {
        console.error("处理订单失败:", e.message);
        return new Response(JSON.stringify({ error: "处理订单失败", details: e.message }), {
            status: 500
        });
    }
}

/** GET /api/export: 导出订单数据为 CSV (Excel 兼容) */
async function handleExportOrders(env) {
    const orders = await getR2Json(env, DATA_KEY, []);
    if (orders.length === 0) {
        return new Response("无订单数据可导出", { status: 404 });
    }

    // 1. 定义 CSV 表头和字段
    const headers = ["订单ID", "客户名称", "货物内容", "金额", "订单日期", "上传时间", "图片键名"];
    const keys = ["order_id", "customer_name", "item_content", "amount", "order_date", "upload_date", "image_r2_key"];

    // 2. 格式化数据为 CSV 字符串
    let csv = headers.join(",") + "\n"; // 表头
    orders.forEach(order => {
        const row = keys.map(key => {
            let value = order[key] !== undefined && order[key] !== null ? String(order[key]).replace(/"/g, '""') : "";
            // 确保内容中的逗号不会破坏 CSV 结构，用双引号包裹
            if (value.includes(",")) {
                value = `"${value}"`;
            }
            return value;
        }).join(",");
        csv += row + "\n";
    });

    // 3. 返回 CSV 文件
    return new Response(csv, {
        headers: {
            "Content-Type": "text/csv; charset=utf-8",
            "Content-Disposition": `attachment; filename="orders_export_${new Date().toISOString().substring(0, 10)}.csv"`
        },
    });
}

// --- 路由和 Worker 入口 ---

// 使用 Workers Sites/Pages 路由来处理静态资源和 API 请求
export default {
    async fetch(request, env, ctx) {
        const url = new URL(request.url);

        // API 路由
        if (url.pathname.startsWith("/api/")) {
            const path = url.pathname.substring(4); // 移除 /api

            if (path === "/config" && request.method === "GET") {
                return handleGetConfig(env);
            }
            if (path === "/config" && request.method === "POST") {
                return handleUpdateConfig(request, env);
            }
            if (path === "/orders" && request.method === "GET") {
                return handleGetOrders(env);
            }
            if (path === "/upload" && request.method === "POST") {
                return handleUpload(request, env);
            }
            if (path === "/export" && request.method === "GET") {
                return handleExportOrders(env);
            }
            // 默认 API 404
            return new Response("API Not Found", { status: 404 });
        }

        // 处理静态文件 (如 index.html)
        return env.ASSETS.fetch(request);
    },
};

````

## 3\. 前端界面 (`src/static/index.html`)

将以下代码保存为 `src/static/index.html`。它包含配置表单、订单上传表单和订单列表。

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare 订单管理系统</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="file"], button { padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .config-form { border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .message { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions { display: flex; gap: 10px; margin-bottom: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>订单管理系统 (R2 + AI 识别)</h1>
    <div id="statusMessage" class="message hidden"></div>

    <h2>大模型 API 配置</h2>
    <div class="config-form">
        <form id="configForm">
            <label for="apiUrl">服务商 URL 地址 (兼容 OpenAI)</label>
            <input type="text" id="apiUrl" required placeholder="例如: https://api.openai.com/v1/chat/completions">
            
            <label for="modelName">大模型名称</label>
            <input type="text" id="modelName" required placeholder="例如: gpt-4o-mini 或 gemini-2.5-flash">
            
            <button type="submit">保存配置</button>
        </form>
    </div>

    <h2>订单上传与识别</h2>
    <form id="uploadForm">
        <label for="orderImage">上传手写订单照片 (兼容手机拍照)</label>
        <input type="file" id="orderImage" name="orderImage" accept="image/*" capture="camera" required>
        
        <button type="submit" id="uploadButton">上传并识别订单</button>
    </form>

    <h2>所有订单</h2>
    <div class="actions">
        <button onclick="fetchOrders()">刷新订单列表</button>
        <button onclick="exportOrders()">导出为 Excel (CSV)</button>
    </div>
    
    <table id="ordersTable">
        <thead>
            <tr>
                <th>订单 ID</th>
                <th>客户名称</th>
                <th>货物内容</th>
                <th>金额</th>
                <th>订单日期</th>
                <th>上传时间</th>
                <th>图片键名</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    const apiUrlInput = document.getElementById('apiUrl');
    const modelNameInput = document.getElementById('modelName');
    const configForm = document.getElementById('configForm');
    const uploadForm = document.getElementById('uploadForm');
    const ordersTableBody = document.querySelector('#ordersTable tbody');
    const statusMessage = document.getElementById('statusMessage');

    // 消息提示函数
    function showMessage(msg, type = 'success') {
        statusMessage.textContent = msg;
        statusMessage.className = `message ${type}`;
        statusMessage.classList.remove('hidden');
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    }

    // 1. 加载配置
    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('加载配置失败');
            const config = await response.json();
            apiUrlInput.value = config.api_url || '';
            modelNameInput.value = config.model_name || '';
        } catch (error) {
            console.error('配置加载失败:', error);
            showMessage('初始化配置失败，请手动填写并保存。', 'error');
        }
    }

    // 2. 提交配置
    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const newConfig = {
                api_url: apiUrlInput.value,
                model_name: modelNameInput.value
            };
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newConfig)
            });

            if (!response.ok) throw new Error('保存失败');
            showMessage('API 配置保存成功！', 'success');
        } catch (error) {
            console.error('配置保存失败:', error);
            showMessage('保存配置失败。', 'error');
        }
    });

    // 3. 订单上传与识别
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const uploadButton = document.getElementById('uploadButton');
        uploadButton.disabled = true;
        uploadButton.textContent = '正在上传并识别中...请勿关闭';
        
        try {
            const formData = new FormData(uploadForm);
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || '识别失败');
            }
            
            showMessage(`订单识别成功！订单ID: ${result.data.order_id}`, 'success');
            // 刷新列表
            await fetchOrders();
        } catch (error) {
            console.error('上传或识别失败:', error);
            showMessage(`上传/识别失败: ${error.message}`, 'error');
        } finally {
            uploadButton.disabled = false;
            uploadButton.textContent = '上传并识别订单';
            uploadForm.reset();
        }
    });

    // 4. 获取订单列表
    async function fetchOrders() {
        ordersTableBody.innerHTML = '<tr><td colspan="7">正在加载订单...</td></tr>';
        try {
            const response = await fetch('/api/orders');
            if (!response.ok) throw new Error('加载订单列表失败');
            
            const orders = await response.json();
            ordersTableBody.innerHTML = ''; // 清空现有数据

            if (orders.length === 0) {
                 ordersTableBody.innerHTML = '<tr><td colspan="7">暂无订单数据。</td></tr>';
                 return;
            }

            orders.forEach(order => {
                const row = ordersTableBody.insertRow();
                row.insertCell().textContent = order.order_id;
                row.insertCell().textContent = order.customer_name;
                row.insertCell().textContent = order.item_content;
                row.insertCell().textContent = order.amount.toFixed(2);
                row.insertCell().textContent = order.order_date;
                row.insertCell().textContent = new Date(order.upload_date).toLocaleString();
                // 图片键名作为参考，可点击查看图片（需要设置R2公开访问，或通过Workers代理访问）
                row.insertCell().textContent = order.image_r2_key; 
            });
            showMessage(`成功加载 ${orders.length} 条订单记录。`, 'success');

        } catch (error) {
            console.error('获取订单列表失败:', error);
            ordersTableBody.innerHTML = '<tr><td colspan="7" class="error">加载订单数据失败。</td></tr>';
            showMessage('加载订单列表失败。', 'error');
        }
    }

    // 5. 导出 CSV
    function exportOrders() {
        // 直接访问导出 API 路由，浏览器会自动处理下载
        window.open('/api/export', '_blank');
        showMessage('正在生成并下载 CSV 文件...', 'success');
    }

    // 页面加载时执行
    window.onload = () => {
        loadConfig();
        fetchOrders();
    };
</script>

</body>
</html>
```

